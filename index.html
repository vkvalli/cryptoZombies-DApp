<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8">
  <title>CryptoZombies front-end</title>
  <link rel="icon" href="favicon.ico">
  <script language="javascript" type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
  <script language="javascript" type="text/javascript" src="cryptozombies_abi.js"></script>

  <style>
    /* ---------- Page Layout ---------- */
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e3a8a, #111827);
      color: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 60px;
      font-size: 2.5rem;
      color: #c4b5fd;
      text-shadow: 0 0 18px rgba(167,139,250,0.6);
      text-align: center;
    }

    #txStatus {
      margin-top: 20px;
      padding: 10px 25px;
      background: rgba(99,102,241,0.15);
      border: 1px solid rgba(139,92,246,0.5);
      border-radius: 10px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 0 10px rgba(139,92,246,0.4);
    }

    /* ---------- Buttons ---------- */
    .button-group {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    button {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 22px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(124,58,237,0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(124,58,237,0.6);
    }

    /* ---------- Zombie Cards ---------- */
    #zombies {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
      padding: 40px 20px;
      box-sizing: border-box;
    }

    .zombie {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 15px;
      padding: 15px 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      transition: transform 0.2s ease;
    }

    .zombie:hover {
      transform: translateY(-4px);
    }

    .zombie ul {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 14px;
    }

    .zombie li {
      margin: 6px 0;
    }
  </style>
</head>

<body>
  <h1>üßü‚Äç‚ôÇÔ∏è Welcome to CryptoZombies Factory</h1>
  <div id="accountInfo"
     style="padding:10px;margin-top:10px;font-weight:600;
            background:rgba(255,255,255,0.1);
            border-radius:8px;width:90%;text-align:center;">
  Connecting...
</div>
  <div id="txStatus"></div>
  <div id="zombies"></div>

  <div class="button-group">
    <button class="showZombieButton">Show Zombies</button>
    <button class="createzombieButton">Create Zombie</button>
    <button class="levelupButton">Level Up</button>
    <button class="feedZombieButton">Feed on Kitty</button>
    <button class="createKittyButton">Create Test Kitties</button>
    <button class="battleButton">Battle Zombies</button>
  </div>
  

  <script>

    var cryptoZombies;
    var userAccount;
    const showZombieButton = document.querySelector('.showZombieButton');
    const createzombieButton = document.querySelector('.createzombieButton');
    const levelupButton = document.querySelector('.levelupButton');

    function startApp() {
	
      //ZombieOwnership contract address
      var cryptoZombiesAddress = "0xe982E462b094850F12AF94d21D470e21bE9D0E9C";

      cryptoZombies = new web3.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);


 //the following code from Lesson 6, chapter 5 is obsolete
 //     var accountInterval = setInterval(function () {

  //      if (web3.eth.accounts[0] !== userAccount) {
          //userAccount = web3.eth.accounts[0];

     //     getZombiesByOwner(userAccount)
      //      .then(displayZombies);
      //  }
     // }, 100);

      cryptoZombies.events.Transfer({ filter: { _to: userAccount } })
        .on("data", function (event) {
          let data = event.returnValues;
          getZombiesByOwner(userAccount).then(displayZombies);
        }).on("error", console.error);

      $("#accountInfo").text(`üîó Connected: ${userAccount} (Network: Ganache 1337)`);

    }

    // cryptoZombies.methods.KittyContract().call().then(addr=>{
    //   console.log("Kitty contract linked to:", addr);
    // });

    function displayZombies(ids) {
      $("#zombies").empty();
      for (id of ids) {

        getZombieDetails(id)
          .then(function (zombie) {

            const imgUrl = `https://robohash.org/${zombie.dna}?set=set3`;
            $("#zombies").append(`<div class="zombie"> <img src="${imgUrl}" width="100%" 
            style="border-radius:10px;margin-bottom:8px;
                box-shadow:0 4px 10px rgba(0,0,0,0.4);">
              <ul>
                <li>Name: ${zombie.name}</li>
                <li>DNA: ${zombie.dna}</li>
                <li>Level: ${zombie.level}</li>
                <li>Wins: ${zombie.winCount}</li>
                <li>Losses: ${zombie.lossCount}</li>
                <li>Ready Time: ${zombie.readyTime}</li>
              </ul>
            </div>`);
          });
      }

    }

    function createRandomZombie(name) {


      $("#txStatus").text("Creating new zombie on the blockchain. This may take a while...");

      return cryptoZombies.methods.createRandomZombie(name)
        .send({ from: userAccount })
        .on("receipt", function (receipt) {
          $("#txStatus").text("Successfully created " + name + "!");

          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {

          $("#txStatus").text(error);
        });
    }

    function feedOnKitty(zombieId, kittyId) {
      $("#txStatus").text("Eating a kitty. This may take a while...");
      return cryptoZombies.methods.feedOnKitty(zombieId, kittyId)
        .send({ from: userAccount })
        .on("receipt", function (receipt) {
          $("#txStatus").text("Ate a kitty and spawned a new Zombie!");
          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {
          console.error("FeedOnKitty failed:", error);
          const msg = error && error.message ? error.message : JSON.stringify(error, null, 2);
          $("#txStatus").text("‚ùå" + msg);
        });
    }

    function levelUp(zombieId) {
      $("#txStatus").text("Leveling up your zombie...");
      return cryptoZombies.methods.levelUp(zombieId)
        .send({ from: userAccount, value: web3.utils.toWei("0.001", "ether") })
        .on("receipt", function (receipt) {
          $("#txStatus").text("Power overwhelming! Zombie successfully leveled up");
        })
        .on("error", function (error) {
          $("#txStatus").text(error);
        });
    }

    function getZombieDetails(id) {
      return cryptoZombies.methods.zombies(id).call()
    }

    function zombieToOwner(id) {
      return cryptoZombies.methods.zombieToOwner(id).call()
    }

    function getZombiesByOwner(owner) {
      return cryptoZombies.methods.getZombiesByOwner(owner).call()
    }

    const feedZombieButton=document.querySelector('.feedZombieButton');
    feedZombieButton.addEventListener('click', async () =>{
      const zombieId=prompt("Enter your Zombie ID:");
      const kittyId=prompt("Enter Kitty ID to feed on:");
      if (!zombieId||!kittyId) return;
      await feedOnKitty(zombieId,kittyId);
    })

    async function createTestKitties() {
      const KittyContract = new web3.eth.Contract(
        [ // ABI subset (only what we need)
          {
            "inputs": [{"name": "_genes","type": "uint256"}, {"name": "_generation","type": "uint16"}],
            "name": "createKitty",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
          },
          {
            "inputs": [{"name": "_id","type": "uint256"}],
            "name": "getKitty",
            "outputs": [
              {"name": "isGestating","type": "bool"},
              {"name": "isReady","type": "bool"},
              {"name": "cooldownIndex","type": "uint256"},
              {"name": "nextActionAt","type": "uint256"},
              {"name": "siringWithId","type": "uint256"},
              {"name": "birthTime","type": "uint256"},
              {"name": "matronId","type": "uint256"},
              {"name": "sireId","type": "uint256"},
              {"name": "generation","type": "uint256"},
              {"name": "genes","type": "uint256"}
            ],
            "stateMutability": "view",
            "type": "function"
          }
        ],
        "0xe93e3B649d4E01e47dd2170CAFEf0651477649Da" //kittycontract address
      );

      $("#txStatus").text("Creating test kitties...");
      await KittyContract.methods.createKitty(987654321, 0).send({from: userAccount});
      await KittyContract.methods.createKitty(555777999, 1).send({from: userAccount});
      $("#txStatus").text("‚úÖ Test kitties created! You can now feed your zombies on Kitty #0 or #1.");
    }

    document.querySelector('.createKittyButton').addEventListener('click', createTestKitties);

    window.addEventListener('load', async () => {
      if (typeof window.ethereum === 'undefined') {
        console.log('MetaMask not detected! Please install it.');
        return;
      }

      window.web3 = new Web3(window.ethereum);

      try {
        // Request MetaMask access
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accounts[0];
        console.log("Connected account:", userAccount);

        // Ensure correct network (Ganache = chainId 0x539)
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        console.log("Current network chainId:", chainId);

        if (chainId !== '0x539') {
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x539' }],
            });
            console.log("‚úÖ Switched MetaMask to Ganache network.");
          } catch (switchError) {
            console.error("‚ùå Unable to switch network:", switchError);
            alert("Please switch MetaMask to the Ganache network (http://127.0.0.1:7545).");
            return;
          }
        }

        // Start app once network and account are ready
        startApp();

      } catch (error) {
        console.error("Error connecting to MetaMask:", error);
        alert("Please unlock MetaMask and allow access to continue.");
      }

      // Handle network/account changes dynamically
      ethereum.on('accountsChanged', (accounts) => {
        userAccount = accounts[0];
        console.log("Switched account:", userAccount);
        startApp();
      });

      ethereum.on('chainChanged', (chainId) => {
        console.log("Network changed:", chainId);
        window.location.reload();
      });
    });

 
   //the following code from Lesson 6, chapter 2 is obsolete
   //metamask no longer inject web3 since early 2021
   //window.addEventListener('load', function () {

  //    if (typeof web3 !== 'undefined') {
   //     web3js = new Web3(web3.currentProvider);
   //   } else {

    //  }


    //  startApp()

  //  }) 

   ethereum.on('accountsChanged', (accounts) => {
       window.location.reload();
   });

   ethereum.on('chainChanged', (chainId) => {
       window.location.reload(); 
   });  

 
    createzombieButton.addEventListener('click', () => {
      //createRandomZombie(userAccount);
      // give each zombie a different name so DNA differs
      const randomName = `Z-${Math.random().toString(36).slice(2,7)}-${Date.now().toString().slice(-4)}`;
      createRandomZombie(randomName);
    });

    showZombieButton.addEventListener('click', () => {
      getZombiesByOwner(userAccount)
            .then(displayZombies);

    });

    levelupButton.addEventListener('click', async () => {
      const ids = await getZombiesByOwner(userAccount);
      if (!ids.length) { $("#txStatus").text("You don‚Äôt own any zombies yet."); return; }

      const idToLevel = prompt(`Enter a zombie id to level up: ${ids.join(', ')}`, ids[ids.length - 1]);
      if (!idToLevel) return;

      await levelUp(idToLevel);
      const after = await getZombiesByOwner(userAccount);
      displayZombies(after);
    });

    // --- Battle button logic ---
    const battleButton = document.querySelector('.battleButton');

    if (battleButton) {
      battleButton.addEventListener('click', async () => {
        const zombieId = prompt("Enter your Zombie ID:");
        const targetId = prompt("Enter the target Zombie ID to battle:");
        if (!zombieId || !targetId) return;

        $("#txStatus").text("‚öî Battling zombies...");
        try {
          await cryptoZombies.methods.attack(zombieId, targetId)
            .send({ from: userAccount });

          $("#txStatus").text("‚úÖ Battle complete! Check stats under Show Zombies.");
          const after = await getZombiesByOwner(userAccount);
          displayZombies(after);
        } catch (error) {
          console.error("Battle failed:", error);
          const msg = error && error.message ? error.message : JSON.stringify(error, null, 2);
          $("#txStatus").text("‚ùå " + msg);
        }
      });
    }


  </script>
</body>

</html>